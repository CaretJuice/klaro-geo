# datalayer-events.spec.yaml
# Specification for DataLayer Event Architecture
#
# CRITICAL: All plugin actions flow through window.dataLayer

file_meta:
  purpose: "Define dataLayer event contracts for GTM/analytics integration"
  dependencies:
    - "klaro-geo-config.php"
    - "klaro-geo-consent-receipts.js"
    - "external: Klaro library"
  stability: "core"
  last_updated: "2026-01-09"

# =============================================================================
# ARCHITECTURE PRINCIPLE
# =============================================================================
architecture:
  principle: "DataLayer-First Design"
  description: |
    Everything flows through window.dataLayer. This enables:
    - Tag Manager integration (GTM, etc.)
    - Analytics tracking
    - Event-driven activation of scripts/services
    - Debugging and monitoring
    - Separation of concerns (consent logic vs. tracking logic)

  event_sources:
    plugin_derived:
      description: "Events generated by Klaro Geo plugin code"
      examples:
        - "klaroConfigLoaded"
        - "Consent receipt creation"
        - "Geo-detection results"

    klaro_forwarded:
      description: "Events from Klaro library forwarded to dataLayer"
      examples:
        - "Consent changes"
        - "Modal open/close"
        - "Service activation"
        - "Accept all / Decline all"

  eventSource_convention: |
    The eventSource field is only included on events with event: 'Klaro Event',
    where it discriminates between 'klaro' (forwarded from Klaro library) and
    'klaro-geo' (generated by the plugin). Events with unique event names
    (e.g., 'Klaro Consent Data', 'Klaro Geo Consent Receipt') do not include
    eventSource because the event name itself identifies the source.

# =============================================================================
# EVENT CONTRACTS
# =============================================================================
events:
  # ---------------------------------------------------------------------------
  # PLUGIN-DERIVED EVENTS
  # ---------------------------------------------------------------------------
  klaroConfigLoaded:
    purpose: "Fired when klaro-config.js is loaded and config is available"
    source: "klaro-geo-config.php"
    trigger: "Config file execution in browser"

    required_fields:
      event:
        type: "string"
        value: "Klaro Event"
        description: "Standard event wrapper for GTM triggers"

      eventSource:
        type: "string"
        value: "klaro-geo"
        description: "Identifies this as a Klaro Geo event"

      klaroEventName:
        type: "string"
        value: "klaroConfigLoaded"
        description: "Specific event identifier"

      klaroGeoConsentTemplate:
        type: "string"
        description: "Template key being used (e.g., 'opt-in', 'opt-out')"
        example: "opt-out"

      klaroGeoTemplateSource:
        type: "string"
        enum: ["default", "fallback", "country", "region"]
        description: "Where the template came from"

      klaroGeoDetectedCountry:
        type: "string|null"
        description: "Detected country code or null if not detected"
        example: "US"

      klaroGeoDetectedRegion:
        type: "string|null"
        description: "Detected region code or null"
        example: "CA"

      klaroGeoAdminOverride:
        type: "boolean"
        description: "Whether admin debug override is active"

      klaroGeoEnableConsentLogging:
        type: "boolean"
        description: "Whether consent receipts are enabled"

    optional_fields:
      klaroGeoConsentReceiptId:
        type: "string"
        description: "Receipt ID of the latest consent receipt if available"

    example:
      event: "Klaro Event"
      eventSource: "klaro-geo"
      klaroEventName: "klaroConfigLoaded"
      klaroGeoConsentTemplate: "opt-out"
      klaroGeoTemplateSource: "country"
      klaroGeoDetectedCountry: "US"
      klaroGeoDetectedRegion: null
      klaroGeoAdminOverride: false
      klaroGeoEnableConsentLogging: true

    contract: |
      - MUST fire on every page load where klaro-config.js is included
      - MUST include accurate template and geo information
      - If cookieDomain is set, that template's cookieDomain should be used
      - Can be used to verify correct template selection

  # ---------------------------------------------------------------------------
  # KLARO CONSENT UPDATE EVENT (always fired - consent mode is always enabled)
  # ---------------------------------------------------------------------------
  klaroConsentUpdate:
    purpose: "Fired when consent state changes - includes full consent mode object"
    source: "klaro-geo.js"
    trigger: "initialConsents or saveConsents events from Klaro manager"

    required_fields:
      event:
        type: "string"
        value: "Klaro Consent Update"
        description: "Distinct event name for consent updates"

      eventSource:
        type: "string"
        value: "klaro-geo"
        description: "Identifies this as a Klaro Geo event"

      consentMode:
        type: "object"
        description: "Complete consent mode object with all keys"
        required_keys:
          ad_storage: "'granted' | 'denied'"
          analytics_storage: "'granted' | 'denied'"
          ad_user_data: "'granted' | 'denied'"
          ad_personalization: "'granted' | 'denied'"
        dynamic_keys:
          pattern: "[service_name]_consent"
          value: "'granted' | 'denied'"
          description: "One key per service in Klaro config"

      acceptedServices:
        type: "array"
        description: "Array of service names that have consent granted"
        example: ["google-analytics", "piwik"]

      triggerEvent:
        type: "string"
        enum: ["initialConsents", "saveConsents"]
        description: "Which Klaro event triggered this update"

    example:
      event: "Klaro Consent Update"
      eventSource: "klaro-geo"
      consentMode:
        ad_storage: "denied"
        analytics_storage: "granted"
        ad_user_data: "denied"
        ad_personalization: "denied"
        google_analytics_consent: "granted"
        piwik_consent: "granted"
        facebook_consent: "denied"
      acceptedServices: ["google-analytics", "piwik"]
      triggerEvent: "saveConsents"

    contract: |
      - MUST always be fired on consent changes (consent mode is always enabled)
      - MUST include consentMode object with all standard Google keys
      - MUST include dynamic [service]_consent keys for ALL services
      - Dynamic keys use 'granted' for true consent, 'denied' for false
      - acceptedServices array contains only services with consent=true
      - NOTE: The plugin does NOT call gtag('consent', 'update', ...) directly
      - The GTM template reads this event and calls updateConsentState() API
      - This architecture ensures consent state is updated BEFORE tags evaluate

  # ---------------------------------------------------------------------------
  # KLARO FORWARDED EVENTS (examples - Klaro may add more)
  # ---------------------------------------------------------------------------
  klaroConsentChanged:
    purpose: "Fired when user changes consent preferences"
    source: "Klaro library → Klaro Geo forwarding"

    required_fields:
      event:
        type: "string"
        value: "Klaro Event"

      eventSource:
        type: "string"
        value: "klaro-geo"

      klaroEventName:
        type: "string"
        value: "consent"

    contract: |
      - Forwards Klaro's consent events to dataLayer
      - Enables GTM triggers based on consent changes
      - Should include service-level consent states

# =============================================================================
# INTEGRATION CONTRACTS
# =============================================================================
integration:
  gtm_template:
    description: "Klaro Geo GTM Community Template (recommended approach)"
    location: "gtm-template/ subdirectory in klaro-geo repo"

    why_use_template: |
      The GTM template uses native setDefaultConsentState() and updateConsentState()
      APIs which update consent state IMMEDIATELY. This fixes a critical timing issue:
      - gtag('consent', 'update', ...) commands are QUEUED and may not process
        before the next event begins
      - Native consent APIs update state synchronously BEFORE tags evaluate
      - This ensures tags with consent requirements fire correctly

    setup:
      step_1: "Import Klaro Geo template into GTM workspace"
      step_2: "Create 'Klaro Geo - Default' tag on Consent Initialization trigger"
      step_3: "Create 'Klaro Geo - Update' tag on 'Klaro Consent Update' event trigger"
      step_4: "Configure tags with consent requirements (analytics_storage, google_analytics_consent, etc.)"

    tag_configuration:
      default_tag:
        trigger: "Consent Initialization - All Pages"
        command: "default"
        settings: "Set all consent types to 'denied' with wait_for_update timeout"
        note: "Does NOT read Klaro cookie - waits for Klaro Consent Update event"

      update_tag:
        trigger: "Custom Event: Klaro Consent Update"
        command: "update"
        settings: "Reads consentMode from dataLayer and calls updateConsentState()"
        note: "Also pushes klaro_consent_granted_pageview for first-page attribution"

    supported_consent_types:
      standard_google:
        - analytics_storage
        - ad_storage
        - ad_user_data
        - ad_personalization
      custom_service:
        - google_analytics_consent
        - google_ads_consent
        - google_tag_manager_consent
        - "[any service]_consent keys from consentMode object"

    contract: |
      - Plugin MUST push 'Klaro Consent Update' events with consentMode object
      - GTM template reads consentMode and calls updateConsentState()
      - Consent state is updated BEFORE any tags evaluate
      - First-page attribution is handled via klaro_consent_granted_pageview event

  google_tag_manager:
    description: "GTM integration via dataLayer (legacy/advanced patterns)"
    trigger_recommendations:
      - trigger: "Klaro Config Loaded"
        condition: "event equals 'Klaro Event' AND klaroEventName equals 'klaroConfigLoaded'"
        use_case: "Initialize tracking based on detected template"

      - trigger: "Klaro Consent Update"
        condition: "event equals 'Klaro Consent Update'"
        use_case: "Fire tags based on consent mode state changes"
        notes: |
          Access dynamic service keys via consentMode object:
          - {{consentMode.google_analytics_consent}} for Google Analytics
          - {{consentMode.piwik_consent}} for Piwik/Matomo
          - etc.

      - trigger: "Consent Given"
        condition: "event equals 'Klaro Event' AND klaroEventName equals 'consent'"
        use_case: "Activate marketing tags when consent given"

  other_tag_managers:
    description: "Integration with non-GTM tag managers"
    notes: |
      The dataLayer format follows GTM conventions but can be read by other tag managers.
      Key data available in 'Klaro Consent Update' event:
      - consentMode: Object with all consent keys (both Google standard and dynamic)
      - acceptedServices: Array of service names with granted consent
      - triggerEvent: 'initialConsents' or 'saveConsents'

  debugging:
    description: "Debug events in browser console"
    method: |
      // In browser console:
      window.dataLayer.filter(e => e.event === 'Klaro Event')

# =============================================================================
# TEST SCENARIOS
# =============================================================================
test_scenarios:
  critical:
    - "klaroConfigLoaded fires on page load"
    - "klaroConfigLoaded includes correct template name"
    - "klaroConfigLoaded includes correct template source"
    - "Geo detection results are accurate in event"
    - "Consent events are forwarded to dataLayer"
    - "klaroConsentUpdate always includes consentMode object"
    - "Dynamic service keys are generated for all services"
    - "Service names with hyphens are sanitized (hyphens -> underscores)"
    - "Denied services have value 'denied', not omitted"
    - "Only ONE 'Klaro Consent Update' event fires per consent state change"
    - "Plugin does NOT call gtag('consent', 'default') or gtag('consent', 'update')"

  gtm_template_integration:
    - "GTM Default tag sets all consent to denied initially"
    - "GTM Update tag reads consentMode from 'Klaro Consent Update' event"
    - "updateConsentState() is called BEFORE trigger fires"
    - "klaro_consent_granted_pageview fires on first consent grant"
    - "Tags with analytics_storage requirement fire after consent"
    - "Tags with custom consent types (google_analytics_consent) fire after consent"

  edge_cases:
    - "Event fires even when no geo detected"
    - "Event fires when using fallback template"
    - "Event includes consent receipt when available"
    - "Dynamic keys don't conflict with reserved Google keys"
    - "Empty service list still includes standard Google keys"

# =============================================================================
# DEBUGGING
# =============================================================================
debugging:
  verify_events:
    description: "How to verify events are firing correctly"
    steps:
      - "Open browser DevTools → Console"
      - "Run: window.dataLayer.filter(e => e.eventSource === 'klaro-geo')"
      - "Check klaroGeoConsentTemplate matches expected template"
      - "Check klaroGeoTemplateSource shows correct resolution path"
      - "Verify cookieDomain in klaroConfig matches template"

  common_issues:
    dataLayer_undefined:
      symptom: "Events not appearing in dataLayer"
      cause: "GTM not loaded before Klaro Geo"
      solution: "Ensure window.dataLayer = window.dataLayer || [] is called early"

    wrong_template:
      symptom: "klaroGeoConsentTemplate doesn't match expected"
      investigation:
        - "Check klaroGeoTemplateSource to see where template came from"
        - "If 'fallback', country may not be configured"
        - "If 'default', requested template may not exist"
