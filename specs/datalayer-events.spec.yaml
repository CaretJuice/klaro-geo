# datalayer-events.spec.yaml
# Specification for DataLayer Event Architecture
#
# CRITICAL: All plugin actions flow through window.dataLayer

file_meta:
  purpose: "Define dataLayer event contracts for GTM/analytics integration"
  dependencies:
    - "klaro-geo-config.php"
    - "klaro-geo-consent-receipts.js"
    - "external: Klaro library"
  stability: "core"
  last_updated: "2025-12-03"

# =============================================================================
# ARCHITECTURE PRINCIPLE
# =============================================================================
architecture:
  principle: "DataLayer-First Design"
  description: |
    Everything flows through window.dataLayer. This enables:
    - Tag Manager integration (GTM, etc.)
    - Analytics tracking
    - Event-driven activation of scripts/services
    - Debugging and monitoring
    - Separation of concerns (consent logic vs. tracking logic)

  event_sources:
    plugin_derived:
      description: "Events generated by Klaro Geo plugin code"
      examples:
        - "klaroConfigLoaded"
        - "Consent receipt creation"
        - "Geo-detection results"

    klaro_forwarded:
      description: "Events from Klaro library forwarded to dataLayer"
      examples:
        - "Consent changes"
        - "Modal open/close"
        - "Service activation"
        - "Accept all / Decline all"

# =============================================================================
# EVENT CONTRACTS
# =============================================================================
events:
  # ---------------------------------------------------------------------------
  # PLUGIN-DERIVED EVENTS
  # ---------------------------------------------------------------------------
  klaroConfigLoaded:
    purpose: "Fired when klaro-config.js is loaded and config is available"
    source: "klaro-geo-config.php"
    trigger: "Config file execution in browser"

    required_fields:
      event:
        type: "string"
        value: "Klaro Event"
        description: "Standard event wrapper for GTM triggers"

      eventSource:
        type: "string"
        value: "klaro-geo"
        description: "Identifies this as a Klaro Geo event"

      klaroEventName:
        type: "string"
        value: "klaroConfigLoaded"
        description: "Specific event identifier"

      klaroGeoConsentTemplate:
        type: "string"
        description: "Template key being used (e.g., 'opt-in', 'opt-out')"
        example: "opt-out"

      klaroGeoTemplateSource:
        type: "string"
        enum: ["default", "fallback", "country", "region"]
        description: "Where the template came from"

      klaroGeoDetectedCountry:
        type: "string|null"
        description: "Detected country code or null if not detected"
        example: "US"

      klaroGeoDetectedRegion:
        type: "string|null"
        description: "Detected region code or null"
        example: "CA"

      klaroGeoAdminOverride:
        type: "boolean"
        description: "Whether admin debug override is active"

      klaroGeoEnableConsentLogging:
        type: "boolean"
        description: "Whether consent receipts are enabled"

    optional_fields:
      klaroGeoConsentReceipt:
        type: "object"
        description: "Latest consent receipt if available"

    example:
      event: "Klaro Event"
      eventSource: "klaro-geo"
      klaroEventName: "klaroConfigLoaded"
      klaroGeoConsentTemplate: "opt-out"
      klaroGeoTemplateSource: "country"
      klaroGeoDetectedCountry: "US"
      klaroGeoDetectedRegion: null
      klaroGeoAdminOverride: false
      klaroGeoEnableConsentLogging: true

    contract: |
      - MUST fire on every page load where klaro-config.js is included
      - MUST include accurate template and geo information
      - If cookieDomain is set, that template's cookieDomain should be used
      - Can be used to verify correct template selection

  # ---------------------------------------------------------------------------
  # KLARO FORWARDED EVENTS (examples - Klaro may add more)
  # ---------------------------------------------------------------------------
  klaroConsentChanged:
    purpose: "Fired when user changes consent preferences"
    source: "Klaro library → Klaro Geo forwarding"

    required_fields:
      event:
        type: "string"
        value: "Klaro Event"

      eventSource:
        type: "string"
        value: "klaro-geo"

      klaroEventName:
        type: "string"
        value: "consent"

    contract: |
      - Forwards Klaro's consent events to dataLayer
      - Enables GTM triggers based on consent changes
      - Should include service-level consent states

# =============================================================================
# INTEGRATION CONTRACTS
# =============================================================================
integration:
  google_tag_manager:
    description: "GTM integration via dataLayer"
    trigger_recommendations:
      - trigger: "Klaro Config Loaded"
        condition: "event equals 'Klaro Event' AND klaroEventName equals 'klaroConfigLoaded'"
        use_case: "Initialize tracking based on detected template"

      - trigger: "Consent Given"
        condition: "event equals 'Klaro Event' AND klaroEventName equals 'consent'"
        use_case: "Activate marketing tags when consent given"

  debugging:
    description: "Debug events in browser console"
    method: |
      // In browser console:
      window.dataLayer.filter(e => e.event === 'Klaro Event')

# =============================================================================
# TEST SCENARIOS
# =============================================================================
test_scenarios:
  critical:
    - "klaroConfigLoaded fires on page load"
    - "klaroConfigLoaded includes correct template name"
    - "klaroConfigLoaded includes correct template source"
    - "Geo detection results are accurate in event"
    - "Consent events are forwarded to dataLayer"

  edge_cases:
    - "Event fires even when no geo detected"
    - "Event fires when using fallback template"
    - "Event includes consent receipt when available"

# =============================================================================
# DEBUGGING
# =============================================================================
debugging:
  verify_events:
    description: "How to verify events are firing correctly"
    steps:
      - "Open browser DevTools → Console"
      - "Run: window.dataLayer.filter(e => e.eventSource === 'klaro-geo')"
      - "Check klaroGeoConsentTemplate matches expected template"
      - "Check klaroGeoTemplateSource shows correct resolution path"
      - "Verify cookieDomain in klaroConfig matches template"

  common_issues:
    dataLayer_undefined:
      symptom: "Events not appearing in dataLayer"
      cause: "GTM not loaded before Klaro Geo"
      solution: "Ensure window.dataLayer = window.dataLayer || [] is called early"

    wrong_template:
      symptom: "klaroGeoConsentTemplate doesn't match expected"
      investigation:
        - "Check klaroGeoTemplateSource to see where template came from"
        - "If 'fallback', country may not be configured"
        - "If 'default', requested template may not exist"
