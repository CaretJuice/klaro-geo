version: "1.0"
name: klaro-geo-events
description: |
  Event factory module for creating dataLayer events with correct eventSource
  values and fresh consent state. This module centralizes event creation to
  ensure consistency and prevent stale data issues.

file: js/klaro-geo-events.js
type: javascript-module

constants:
  SOURCE_KLARO:
    value: "klaro"
    description: |
      Used for events forwarded from Klaro library. These events represent
      Klaro manager state, not plugin-generated data.
    examples:
      - initialConsents (reading manager's initial state)
      - saveConsents (from manager.watch callback)
      - applyConsents (from manager.watch callback)

  SOURCE_KLARO_GEO:
    value: "klaro-geo"
    description: |
      Used for events generated by the klaro-geo plugin itself. These events
      are plugin-specific and not directly from Klaro.
    examples:
      - generateConsentReceipt
      - Klaro Consent Data (GTM integration event)
      - Klaro Geo Consent Receipt

event_source_rules:
  description: |
    Rules for determining which eventSource to use. This is critical for
    downstream consumers (GTM triggers, analytics) to properly filter events.

  klaro:
    description: Events that forward/represent Klaro library state
    events:
      - name: initialConsents
        reason: Represents Klaro manager's initial consent state from cookies
      - name: saveConsents
        reason: Forwarded from Klaro manager.watch() callback
      - name: applyConsents
        reason: Forwarded from Klaro manager.watch() callback
      - name: consents
        reason: Forwarded from Klaro manager.watch() callback (if not suppressed)

  klaro-geo:
    description: Events generated by klaro-geo plugin
    events:
      - name: generateConsentReceipt
        reason: Plugin generates receipt after consent change
      - name: Klaro Consent Data
        reason: Plugin transforms consent for GTM consumption
      - name: Klaro Geo Consent Receipt
        reason: Plugin event for receipt tracking

functions:
  getConsentState:
    stability: core
    description: |
      Gets fresh consent state from Klaro manager. Always retrieves current
      state to avoid stale data issues that can occur when holding references
      to consent objects.
    returns:
      type: object
      properties:
        manager: Klaro manager instance (may be null)
        consents: Deep copy of current consents object
        acceptedServices: Array of service names with true consent
        consentMode: Google Consent Mode formatted object

  getServiceConsentKey:
    stability: core
    description: |
      Converts a service name to its consent key format.
    parameters:
      - name: serviceName
        type: string
        example: "google-analytics"
    returns:
      type: string
      example: "google_analytics_consent"

  buildConsentMode:
    stability: core
    description: |
      Builds Google Consent Mode object from consents. Includes both standard
      consent mode keys (ad_storage, analytics_storage, etc.) and dynamic
      service-specific keys.
    parameters:
      - name: consents
        type: object
      - name: manager
        type: object
        optional: true
    returns:
      type: object
      properties:
        ad_storage: "'granted' | 'denied'"
        analytics_storage: "'granted' | 'denied'"
        ad_user_data: "'granted' | 'denied'"
        ad_personalization: "'granted' | 'denied'"
        "[service_name]_consent": "Dynamic keys for each service"

  createKlaroForwardedEvent:
    stability: core
    description: |
      Creates an event forwarded from Klaro library. Uses eventSource: 'klaro'.
      Gets fresh consent state to ensure acceptedServices is current.
    parameters:
      - name: eventName
        type: string
        examples: ["saveConsents", "initialConsents", "applyConsents"]
      - name: eventData
        type: any
        description: Event data from Klaro
      - name: config
        type: object
        description: Klaro config object
    returns:
      type: object
      structure:
        event: "Klaro Event"
        eventSource: "klaro"
        klaroEventName: "{eventName}"
        klaroEventData: "{eventData}"
        klaroConfig: "{config}"
        acceptedServices: "Array of accepted service names"

  createKlaroGeoEvent:
    stability: core
    description: |
      Creates an event generated by klaro-geo plugin. Uses eventSource: 'klaro-geo'.
    parameters:
      - name: eventName
        type: string
        examples: ["generateConsentReceipt"]
      - name: additionalData
        type: object
        optional: true
        description: Additional properties to merge into the event
    returns:
      type: object
      structure:
        event: "Klaro Event"
        eventSource: "klaro-geo"
        klaroEventName: "{eventName}"
        "...additionalData": "Merged properties"

  createConsentDataEvent:
    stability: core
    description: |
      Creates consent data event for GTM. This event is consumed by the
      Klaro Geo GTM template to update Google Consent Mode state.
    parameters:
      - name: triggerEvent
        type: string
        description: Event that triggered this (e.g., 'initialConsents', 'saveConsents')
    returns:
      type: object
      structure:
        event: "Klaro Consent Data"
        eventSource: "klaro-geo"
        consentMode: "Google Consent Mode object"
        acceptedServices: "Array of accepted service names"
        triggerEvent: "{triggerEvent}"

  createConsentReceiptEvent:
    stability: core
    description: |
      Creates consent receipt event for dataLayer.
    parameters:
      - name: consentReceipt
        type: object
        description: The consent receipt object
      - name: includeDetails
        type: boolean
        description: Whether to include template_source and admin_override at top level
    returns:
      type: object
      structure:
        event: "Klaro Geo Consent Receipt"
        eventSource: "klaro-geo"
        klaro_geo_consent_receipt: "{consentReceipt}"
        klaro_geo_template_source: "Optional - included if includeDetails=true"
        klaro_geo_admin_override: "Optional - included if includeDetails=true"

breaking_changes:
  - version: "0.4.0"
    change: "initialConsents eventSource changed from 'klaro-geo' to 'klaro'"
    reason: |
      initialConsents represents Klaro manager state (reading from cookies),
      not plugin-generated data. This aligns with saveConsents which also
      uses 'klaro' eventSource.
    migration: |
      Users filtering dataLayer on eventSource === 'klaro-geo' for initial
      consent state will need to update their GTM triggers to filter on
      eventSource === 'klaro' or klaroEventName === 'initialConsents'.

global_export:
  name: KlaroGeoEvents
  properties:
    - SOURCE_KLARO
    - SOURCE_KLARO_GEO
    - getConsentState
    - getServiceConsentKey
    - buildConsentMode
    - createKlaroForwardedEvent
    - createKlaroGeoEvent
    - createConsentDataEvent
    - createConsentReceiptEvent
