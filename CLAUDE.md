# Klaro Geo - Contract-Driven Development Rules

All code changes MUST respect specifications in `specs/*.spec.yaml` files.

## Project Overview

Klaro Geo is a WordPress plugin that provides geo-targeted consent management using the Klaro consent library. It allows different consent templates (opt-in, opt-out, etc.) based on user location.

## Architecture: DataLayer-First Design

**CRITICAL DESIGN PRINCIPLE**: Everything flows through the dataLayer.

### DataLayer Event Architecture

All plugin actions and Klaro events are pushed to `window.dataLayer`. This enables:
- Tag Manager integration (GTM, etc.)
- Analytics tracking
- Event-driven activation
- Debugging and monitoring

### Event Types

1. **Plugin-Derived Events** (generated by Klaro Geo):
   - `klaroConfigLoaded` - Fired when config is generated
   - Consent receipt events
   - Geo-detection events

2. **Klaro-Forwarded Events** (from Klaro library, forwarded to dataLayer):
   - Consent changes
   - Modal interactions
   - Service activations

### Event Structure

All events follow this structure:
```javascript
{
  'event': 'Klaro Event',
  'eventSource': 'klaro-geo',
  'klaroEventName': '<specific_event_name>',
  // Event-specific data...
}
```

### Key Events

| Event | Source | Purpose |
|-------|--------|---------|
| `klaroConfigLoaded` | Plugin | Config file generated, includes template used, geo info |
| Consent events | Klaro→Plugin | User consent decisions forwarded to dataLayer |

## File Organization

- Every `.php` file with business logic has a corresponding `.spec.yaml`
- Specs define contracts, not implementations
- Functions marked `stability: "core"` are immutable without explicit permission

## Directory Structure

```
klaro-geo/
├── specs/                    # Contract specifications
│   ├── klaro-geo-config.spec.yaml
│   ├── class-klaro-geo-template-settings.spec.yaml
│   └── class-klaro-geo-country-settings.spec.yaml
├── includes/                 # Core PHP classes
│   ├── klaro-geo-config.php           # Config generation
│   ├── class-klaro-geo-template-settings.php
│   └── class-klaro-geo-country-settings.php
├── tests/                    # Test suites
└── contract-driven-templates/ # CDD framework
```

## Before Any Code Change

1. Read the corresponding `.spec.yaml`
2. Identify affected state transitions
3. Verify all side_effects are preserved
4. Ensure dataLayer events are maintained
5. Update specs if adding new functionality

## Key Business Rules

### Template Priority (MUST FOLLOW)
1. Database-stored templates PREFERRED over hardcoded defaults
2. Fallback template used when no geo-match
3. Hardcoded defaults ONLY when database is empty/corrupt

### cookieDomain Handling
- Empty string `''` = auto-detect from site URL with leading dot
- Non-empty string = use exactly as specified
- NEVER silently fail - always log when fallbacks used

### DataLayer Requirements
- ALL significant events MUST be pushed to dataLayer
- Event structure MUST be consistent
- Include template source, geo info in relevant events

## Commit Workflow

**IMPORTANT**: Commit after each meaningful change that passes tests.

### When to Suggest a Commit

Suggest using `/commit` after:
- A bug fix is complete and tests pass
- A new feature is implemented and tested
- New tests are added
- Contract specs are created or updated
- Documentation is added or updated
- Refactoring is complete and tests pass

### How to Commit

Use the custom `/commit` command which:
1. Runs the full test suite
2. Only commits if ALL tests pass
3. Generates an appropriate commit message

### Commit Guidelines

- **Atomic commits**: Each commit should be one logical change
- **Minor fixes can be rolled up**: Small related fixes can be combined
- **Always test first**: Never commit without running tests
- **Clear messages**: Commit messages should explain the "why"

### Commit Types

- `fix:` - Bug fixes
- `feat:` - New features
- `test:` - Test additions/changes
- `docs:` - Documentation changes
- `refactor:` - Code refactoring
- `chore:` - Maintenance tasks

## Current Session Goals

<!-- Update this section for each working session -->
- Investigating cookieDomain not applying from templates
- Creating contracts to document expected behavior
- Writing tests to verify contracts

## Working Memory

<!-- Update as you work -->
- Current task: Contract creation and bug investigation
- Context boundaries: Template system, config generation, geo-detection
- Recent decisions: Using contract-driven approach to diagnose issues

## Debug Logging

Enable debug logging to see template selection flow:
```php
define('KLARO_GEO_DEBUG', true);
```

Key log entries to look for:
- "Available template keys in database"
- "Template lookup result"
- "cookieDomain from template config"
- "Using explicit cookieDomain from template" vs "Auto-detecting cookieDomain"
